#!/bin/bash -e
# Generate SSL certificate for OwnTracks (formerly MQTTitude)

echo "* Regenerating TLS keys/cert for OwnTracks"

. /etc/default/inithooks

fatal() {
    echo "fatal: $@" 1>&2
    exit 1
}

# Get username/password for Mosquitto

[ -e $INITHOOKS_CONF ] && . $INITHOOKS_CONF
$INITHOOKS_PATH/bin/owntrackspw.py --username="$APP_USER" --pass="$APP_PASS"

# Exit if openssl is not available
which openssl >/dev/null || fatal "openssl is not installed"

# generate CA certificate

test -d /etc/mosquitto/owntracks  || mkdir -p /etc/mosquitto/owntracks
TARGET=/etc/mosquitto/owntracks  MOSQUITTOUSER=mosquitto /usr/local/owntracks/tools/TLS/generate-CA.sh mqttitude
# chown mosquitto /etc/mosquitto/owntracks/*

chown -R mosquitto /var/log/mosquitto/

# Copy default settings for m2s

test -f /usr/local/owntracks/m2s/settings.py || cp /usr/local/owntracks/default/m2s-settings.py /usr/local/owntracks/m2s/settings.py


# Create config.js for HiveMQ

(
	ipaddr=$(/sbin/ifconfig |
		grep -Eo 'inet (addr:)?([0-9]*\.){3}[0-9]*' |
		grep -Eo '([0-9]*\.){3}[0-9]*' |
		grep -v '127.0.0.1')

	echo "// Generated by $0"
	echo "websocketserver = '${ipaddr}';"
	echo "websocketport = 18883;"
) > /var/www/hivemq-mqtt-web-client/config.js
